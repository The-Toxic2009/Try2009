name: RDP-and-Drive-BiSync-Secondary

on:
  workflow_dispatch:
    inputs:
      triggered_by:
        required: true
      loop_id:
        required: true
  # No schedule here! Only dispatched by main.yml

jobs:
  rdp_bisync_secondary:
    runs-on: windows-latest
    timeout-minutes: 360  # 6 hours for sync window
    env:
      LOOP_ID: secondary
      RDP_USER: 'RDP'
      RDP_PASS: ${{ secrets.RDP_PASS }}
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
      TAILSCALE_API_TOKEN: ${{ secrets.TAILSCALE_API_TOKEN }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
      GOOGLE_TOKEN: ${{ secrets.GOOGLE_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Chocolatey packages
        uses: actions/cache@v4
        with:
          path: C:\ProgramData\chocolatey\lib
          key: ${{ runner.os }}-choco-secondary-${{ hashFiles('**/*.yml') }}

      - name: Optimize Network Settings
        shell: pwsh
        run: |
          # Optimize TCP settings for better network performance
          netsh int tcp set global autotuninglevel=normal
          netsh int tcp set global chimney=enabled
          netsh int tcp set global rss=enabled
          netsh int tcp set global netdma=enabled
          netsh int tcp set supplemental internet congestionprovider=ctcp
          Write-Host "‚úÖ Network settings optimized"

      - name: Install Chocolatey and Essential Tools
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force
          [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.SecurityProtocolType]::Tls12
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco install tailscale rclone -y --no-progress --force
          Write-Host "‚úÖ Essential tools installed"

      - name: Configure RDP user and permissions
        shell: pwsh
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name 'UserAuthentication' -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-In" protocol=TCP dir=in localport=3389 action=allow profile=any
          Restart-Service TermService -Force

          # Create RDP user with retry logic
          $securePass = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force
          $retryCount = 0
          do {
            try {
              if (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue) {
                Set-LocalUser -Name $env:RDP_USER -Password $securePass -ErrorAction Stop
                Write-Host "‚úÖ Updated existing user: $env:RDP_USER"
              } else {
                New-LocalUser -Name $env:RDP_USER -Password $securePass -FullName 'Remote User' -ErrorAction Stop
                Write-Host "‚úÖ Created new user: $env:RDP_USER"
              }
              
              Add-LocalGroupMember -Group 'Administrators' -Member $env:RDP_USER -ErrorAction SilentlyContinue
              Add-LocalGroupMember -Group 'Remote Desktop Users' -Member $env:RDP_USER -ErrorAction SilentlyContinue
              break
            } catch {
              $retryCount++
              if ($retryCount -lt 3) {
                Start-Sleep -Seconds 2
              } else {
                throw
              }
            }
          } while ($retryCount -lt 3)

          echo "RDP_USER=$env:RDP_USER" >> $env:GITHUB_ENV
          echo "RDP_PASS=$env:RDP_PASS" >> $env:GITHUB_ENV

      - name: Start and approve Tailscale
        shell: pwsh
        run: |
          $hostname = "gh-rdp-secondary-$env:GITHUB_RUN_ID"
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=$hostname --accept-routes --accept-dns
          
          # Wait for IP with timeout
          $timeout = 60
          $elapsed = 0
          do {
            Start-Sleep -Seconds 3
            $elapsed += 3
            $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          } while (!$ip -and $elapsed -lt $timeout)
          
          if ($ip) {
            echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
            Write-Host "‚úÖ Tailscale connected: $ip"
            
            # Auto-approve node
            if ($env:TAILSCALE_API_TOKEN) {
              try {
                $node = (& "$env:ProgramFiles\Tailscale\tailscale.exe" status --json | ConvertFrom-Json).Self.ID
                if ($node) {
                  $hdr = @{ Authorization = "Bearer $env:TAILSCALE_API_TOKEN"; 'Content-Type' = 'application/json' }
                  Invoke-RestMethod "https://api.tailscale.com/api/v2/device/$node/authorized" -Method Post -Headers $hdr -Body '{"authorized":true}' -ErrorAction SilentlyContinue
                  Write-Host "‚úÖ Node auto-approved"
                }
              } catch {
                Write-Host "‚ö†Ô∏è Auto-approval failed"
              }
            }
          } else {
            throw "Failed to get Tailscale IP"
          }

      - name: Show connection info
        shell: pwsh
        run: |
          Write-Host "`nüéØ RDP CONNECTION DETAILS (SECONDARY):" -ForegroundColor Green
          Write-Host "======================================" -ForegroundColor Green
          Write-Host "üåê Tailscale IP: $env:TAILSCALE_IP" -ForegroundColor Yellow
          Write-Host "üë§ User: $env:RDP_USER" -ForegroundColor Yellow
          Write-Host "üîê Pass: $env:RDP_PASS" -ForegroundColor Yellow
          Write-Host "‚è∞ Active: 5h 30m, Next main starts at 5h 50m" -ForegroundColor Cyan
          Write-Host "üì± Connect via Android RDP or mstsc.exe" -ForegroundColor White
          Write-Host "üîÑ Seamless continuation from main workflow" -ForegroundColor Magenta
          Write-Host "======================================" -ForegroundColor Green

      - name: Configure rclone for Google Drive with optimizations
        shell: pwsh
        run: |
          $cfg = "$env:USERPROFILE\.config\rclone"
          if (!(Test-Path $cfg)) { New-Item $cfg -ItemType Directory -Force }
          
          $configContent = @"
[gdrive]
type = drive
client_id = $env:GOOGLE_CLIENT_ID
client_secret = $env:GOOGLE_CLIENT_SECRET
scope = drive
token = $env:GOOGLE_TOKEN
chunk_size = 256M
upload_cutoff = 256M
"@
          $configContent | Set-Content "$cfg\rclone.conf"
          Write-Host "‚úÖ rclone configured with optimizations"

      - name: Download storage to Desktop\persistent
        shell: pwsh
        run: |
          $dst = "C:\Users\runneradmin\Desktop\persistent"
          if (!(Test-Path $dst)) { New-Item $dst -ItemType Directory -Force }
          
          Write-Host "üì• Downloading updated files with network optimizations..."
          rclone copy gdrive:/storage $dst --config "$env:USERPROFILE\.config\rclone\rclone.conf" --drive-acknowledge-abuse --drive-skip-gdocs --transfers 8 --checkers 16 --buffer-size 32M --drive-chunk-size 256M --fast-list --retries 3 --timeout 15m --progress
          Write-Host "‚úÖ Files downloaded"

      - name: Grant persistent folder permissions
        shell: pwsh
        continue-on-error: true
        run: |
          $folder = "C:\Users\runneradmin\Desktop\persistent"
          $user = "$env:COMPUTERNAME\$env:RDP_USER"
          
          # Wait for user creation
          Start-Sleep -Seconds 3
          
          # Try icacls first
          try {
            icacls $folder /grant "$user:(OI)(CI)F" /T
            if ($LASTEXITCODE -eq 0) {
              Write-Host "‚úÖ Permissions granted via icacls"
            } else {
              throw "icacls failed"
            }
          } catch {
            # Fallback to PowerShell ACL
            try {
              $acl = Get-Acl $folder
              $accessRule = New-Object System.Security.AccessControl.FileSystemAccessRule("$env:COMPUTERNAME\$env:RDP_USER", "FullControl", "ContainerInherit,ObjectInherit", "None", "Allow")
              $acl.SetAccessRule($accessRule)
              $acl | Set-Acl $folder
              Write-Host "‚úÖ Permissions granted via PowerShell ACL"
            } catch {
              Write-Host "‚ö†Ô∏è Permission setting failed: $($_.Exception.Message)"
            }
          }

      - name: Install VMware Workstation from persistent storage
        shell: pwsh
        run: |
          $exePath = "C:\Users\runneradmin\Desktop\persistent\VMware-workstation-full-17.6.4-24832109.exe"
          if (Test-Path $exePath) {
            Write-Host "üì¶ Installing VMware Workstation Pro..."
            
            # Correct VMware silent install parameters
            $arguments = @(
              '/S'
              '/v"/qn EULAS_AGREED=1 AUTOSOFTWAREUPDATE=0 DATACOLLECTION=0 ADDLOCAL=ALL REBOOT=ReallySuppress"'
            )
            
            $process = Start-Process -FilePath $exePath -ArgumentList $arguments -Wait -PassThru -NoNewWindow
            Write-Host "VMware installation completed with exit code: $($process.ExitCode)"
            
            # Verify installation
            if (Test-Path "C:\Program Files (x86)\VMware\VMware Workstation\vmware.exe") {
              Write-Host "‚úÖ VMware Workstation Pro installed successfully"
            } else {
              Write-Host "‚ö†Ô∏è VMware installation may have failed"
            }
          } else {
            Write-Host "‚ö†Ô∏è VMware installer not found at $exePath"
          }

      - name: Active RDP Session - Wait 5h 30m
        shell: pwsh
        run: |
          Write-Host "üü¢ Secondary RDP session active for 5 hours 30 minutes..." -ForegroundColor Green
          Write-Host "üì± Connect now using the details above" -ForegroundColor Cyan
          Write-Host "‚è∞ Sync starts automatically in 5h 30m" -ForegroundColor Yellow
          Write-Host "üîÑ Next main workflow starts in 5h 50m" -ForegroundColor Yellow
          Write-Host "üîÑ Continuing seamlessly from main workflow" -ForegroundColor Magenta
          Start-Sleep -Seconds 19800  # 5.5 hours

      - name: Pre-sync preparation
        shell: pwsh
        run: |
          Write-Host "üîÑ Starting sync (30 minutes remaining)..." -ForegroundColor Magenta
          $loc = "C:\Users\runneradmin\Desktop\persistent"
          
          # Optimized bidirectional sync
          rclone bisync $loc gdrive:/storage --config "$env:USERPROFILE\.config\rclone\rclone.conf" --drive-acknowledge-abuse --drive-skip-gdocs --resync --resilient --create-empty-src-dirs --transfers 8 --checkers 16 --buffer-size 32M --drive-chunk-size 256M --fast-list --retries 5 --timeout 25m --progress
          Write-Host "‚úÖ Sync completed"

      - name: Wait until 5h 50m to trigger next main
        shell: pwsh
        run: |
          Write-Host "‚è≥ Waiting until 5h 50m to start next main..." -ForegroundColor Yellow
          Start-Sleep -Seconds 1200  # 20 minutes more

      - name: Trigger main workflow (continue cycle)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            console.log('üöÄ Triggering next main workflow to continue cycle...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'main.yml',
              ref: 'main',
              inputs: { 
                triggered_by: 'secondary', 
                loop_id: context.runId.toString()
              }
            });
            console.log('‚úÖ Next main workflow triggered');

      - name: Final 10-minute overlap
        shell: pwsh
        run: |
          Write-Host "üîÑ Final 10-minute handoff period..." -ForegroundColor Cyan
          Write-Host "‚úÖ Next main should be starting now" -ForegroundColor Green
          Start-Sleep -Seconds 600  # 10 minutes

      - name: Secondary workflow complete
        shell: pwsh
        run: |
          Write-Host "`nüéØ SECONDARY WORKFLOW COMPLETE" -ForegroundColor Green
          Write-Host "==============================" -ForegroundColor Green
          Write-Host "‚è∞ Completed: $(Get-Date)" -ForegroundColor Yellow
          Write-Host "üîÑ Next main: Active" -ForegroundColor Yellow
          Write-Host "üíæ Data: Synced" -ForegroundColor Yellow
          Write-Host "üîÑ Cycle: Continues" -ForegroundColor Yellow
          Write-Host "==============================" -ForegroundColor Green
